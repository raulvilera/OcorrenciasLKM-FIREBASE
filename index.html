
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadastro de Ocorr√™ncias - 2025</title>

  <!-- jsPDF para gera√ß√£o local de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ===== Reset/Base ===== */
    * { box-sizing: border-box; margin:0; padding:0; }
    html,body{height:100%}
    body{
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(135deg,#9fe7ff 0%, #b9f7c9 60%, #baf3ff 100%);
      color:#fff; font-weight:800; padding:18px;
    }
    .app{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;gap:18px}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px;border-radius:14px;background:linear-gradient(90deg,rgba(0,31,63,0.95),rgba(0,78,120,0.95));box-shadow:0 8px 30px rgba(0,0,0,0.15)}
    header h1{font-size:20px;margin:0}
    .header-controls{display:flex;gap:10px;align-items:center}
    .card{background:#2f3336;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.15)}
    .flex{display:flex;gap:18px;align-items:flex-start}
    .col{display:flex;flex-direction:column;gap:12px}
    label{display:block;margin-bottom:6px;font-size:13px}
    input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"]{
      width:100%;padding:10px 12px;border-radius:8px;border:none;font-weight:800;font-size:14px;color:#111
    }
    textarea{min-height:110px;resize:vertical;padding-top:12px}
    button{cursor:pointer;border:none;padding:10px 14px;border-radius:8px;font-weight:900;box-shadow:0 6px 18px rgba(0,0,0,0.15)}
    .btn-primary{background:linear-gradient(90deg,#1e3c72,#2a5298);color:#fff}
    .btn-danger{background:linear-gradient(90deg,#e94b4b,#c62828);color:#fff}
    .btn-success{background:linear-gradient(90deg,#4CAF50,#2E7D32);color:#fff}
    .btn-secondary{background:linear-gradient(90deg,#6c757d,#5a6268);color:#fff}
    .subtitle{font-size:14px;color:#d9f2ff;margin-bottom:6px}
    .historyList{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:6px}
    .historyItem{background:rgba(255,255,255,0.06);border-left:5px solid rgba(255,255,255,0.06);padding:12px;border-radius:8px;color:#fff;font-weight:700}
    .historyItem .meta{font-size:13px;color:#dbefff;font-weight:800;display:flex;justify-content:space-between;gap:8px;align-items:center}
    .historyItem .desc{margin-top:8px;color:#e7f7ff;font-weight:600;font-size:14px}
    .modal-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:2000}
    .modal{width:92%;max-width:780px;background:#fff;color:#111;border-radius:12px;padding:14px;max-height:84vh;overflow:auto}
    .studentList{display:flex;flex-direction:column;gap:8px}
    .pill{background:linear-gradient(90deg,#2a5298,#3a6bd1);color:#fff;padding:6px 10px;border-radius:999px;font-weight:800;display:inline-block}
    .muted{opacity:.9;font-weight:700;color:#e7f7ff}
    .qnum{color:#ff3b3b;font-weight:900}
    .login-options {display: flex; gap: 12px; margin-bottom: 18px;}
    .login-option {flex: 1; text-align: center; padding: 12px; border-radius: 8px; cursor: pointer; background: rgba(255,255,255,0.1);}
    .login-option.active {background: linear-gradient(90deg, rgba(0,78,120,0.8), rgba(0,120,120,0.8));}
    .access-area {display: none;}
    
    /* Novos estilos para formul√°rios - √Årea de Gest√£o com campos mais largos */
    .form-row {display: flex; gap: 12px; margin-bottom: 12px;}
    .form-group {flex: 1; display: flex; flex-direction:column;}
    .form-group label {margin-bottom: 6px;}
    .form-group-small {flex: 0.5;}
    .form-group-medium {flex: 1.2;}
    .form-group-large {flex: 2;}
    .form-group-xlarge {flex: 2.5;} /* Novo tamanho para campos maiores */
    
    /* Ajustes espec√≠ficos para a √°rea de gest√£o */
    .gestao-form .form-group {flex: 1;}
    .gestao-form .form-row {margin-bottom: 15px;}
    .gestao-form input, 
    .gestao-form select, 
    .gestao-form textarea {
        width: 100%;
        padding: 12px;
        font-size: 15px;
    }
    
    .checkbox-group {display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;}
    .checkbox-item {background: #efefef; color: #111; padding: 6px 10px; border-radius: 999px; display: inline-flex; align-items: center;}
    .checkbox-item input {margin-right: 4px;}
    
    /* Estilo espec√≠fico para o campo Classifica√ß√£o */
    .classification-container {display: flex; flex-direction: column; width: auto; min-width: 250px;} /* Aumentado */
    
    @media(max-width:980px){
      .flex{flex-direction:column}
      header{flex-direction:column;gap:8px;align-items:flex-start} 
      .login-options {flex-direction: column;}
      .form-row {flex-direction: column;}
      .classification-container {width: 100%;}
      .gestao-form .form-row {flex-direction: column;}
    }
    
    /* loader animation */
    @keyframes spin{to{transform:rotate(360deg)}}
    .loader{width:18px;height:18px;border:3px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;display:inline-block}
  </style>
</head>
<body>
  <div class="app">

    <!-- HEADER -->
    <header>
      <h1>2025 ‚Äî Cadastro de Ocorr√™ncias</h1>
      <div class="header-controls">
        <div id="userDisplay" class="muted">N√£o autenticado</div>
        <button id="btnLogout" class="btn-danger" style="display:none" onclick="logout()">Sair</button>
        <button id="btnDownloadPdf" class="btn-success" style="display:none" onclick="downloadDocument()">Baixar Template</button>
      </div>
    </header>

    <!-- LOGIN -->
    <div id="loginScreen" class="card" style="display:block">
      <div style="max-width:480px;margin:0 auto">
        <div class="subtitle">Selecione o tipo de acesso</div>
        
        <div class="login-options">
          <div class="login-option active" id="optionGestao" onclick="selectLoginOption('gestao')">
            Acesso Gest√£o
          </div>
          <div class="login-option" id="optionProfessor" onclick="selectLoginOption('professor')">
            Acesso Professor
          </div>
        </div>
        
        <div id="loginFormGestao" class="access-area">
          <div class="form-row">
            <div class="form-group form-group-xlarge">
              <label for="emailGestao">E-mail Gest√£o</label>
              <input id="emailGestao" type="email" placeholder="gestao@escola.com">
            </div>
            <div class="form-group form-group-medium">
              <label for="passwordGestao">Senha</label>
              <input id="passwordGestao" type="password" placeholder="senha">
            </div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn-primary" onclick="login('gestao')">Entrar como Gest√£o</button>
            <button class="btn-danger" onclick="fillDemo('gestao')">Demo Gest√£o</button>
          </div>
          <p class="muted" style="margin-top:10px;font-size:13px">
            Use <strong>gestao@escola.com / gestao123</strong> para acesso √† gest√£o
          </p>
        </div>
        
        <div id="loginFormProfessor" class="access-area">
          <div class="form-row">
            <div class="form-group form-group-xlarge">
              <label for="emailProfessor">E-mail Professor</label>
              <input id="emailProfessor" type="email" placeholder="professor@escola.com">
            </div>
            <div class="form-group form-group-medium">
              <label for="passwordProfessor">Senha</label>
              <input id="passwordProfessor" type="password" placeholder="senha">
            </div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn-primary" onclick="login('professor')">Entrar como Professor</button>
            <button class="btn-danger" onclick="fillDemo('professor')">Demo Professor</button>
          </div>
          <p class="muted" style="margin-top:10px;font-size:13px">
            Use <strong>professor@escola.com / prof123</strong> para acesso ao professor
          </p>
        </div>
      </div>
    </div>

    <!-- MAIN APP - GEST√ÉO -->
    <div id="mainAppGestao" style="display:none;flex-direction:column;gap:14px">
      <div class="flex">
        <!-- GEST√ÉO -->
        <div class="card col" style="flex:1">
          <div class="subtitle">CADASTRO ‚Äî GEST√ÉO</div>
          <div class="col gestao-form">
            <!-- S√©rie/Turma em primeiro lugar -->
            <div class="form-row">
              <div class="form-group form-group-xlarge">
                <label>S√©rie / Turma</label>
                <select id="serie_gestao" onchange="carregarAlunosPorTurmaGestao(this.value)">
                  <option value="">-- Selecione a turma --</option>
                </select>
              </div>
            </div>
            
            <!-- Aluno e RA -->
            <div class="form-row">
              <div class="form-group form-group-xlarge">
                <label>Aluno</label>
                <select id="aluno_gestao" onchange="preencherRAGestao(this.value)">
                  <option value="">-- Selecione o aluno --</option>
                </select>
              </div>
              <div class="form-group form-group-medium">
                <label>RA</label>
                <input id="ra_gestao" type="text" readonly>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group form-group-xlarge">
                <label>Professor</label>
                <input id="professor_gestao" type="text">
              </div>
              <div class="form-group form-group-xlarge">
                <label>Disciplina</label>
                <input id="disciplina_gestao" type="text">
              </div>
            </div>
            
            <!-- Classifica√ß√£o com largura ajustada -->
            <div class="form-row">
              <div class="classification-container">
                <label>Classifica√ß√£o</label>
                <select id="classificacao_gestao" onchange="toggleSuspension('gestao')">
                  <option value="">Selecione</option>
                  <option value="OCORR√äNCIA">OCORR√äNCIA</option>
                  <option value="SUSPENS√ÉO">SUSPENS√ÉO</option>
                </select>
              </div>
              <div class="form-group" style="display:none" id="suspensionRow_gestao">
                <label>Data de retorno</label>
                <input id="dataRetorno_gestao" type="date">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea id="descricao_gestao" placeholder="Descri√ß√£o detalhada"></textarea>
              </div>
            </div>

            <div class="form-row">
              <button class="btn-primary" onclick="cadastrarOcorrenciaGestao()">Registrar (Gest√£o)</button>
              <button class="btn-success" onclick="generatePDFLocal()">Gerar PDF (local)</button>
            </div>

            <div id="successGestao" style="display:none;margin-top:10px;background:linear-gradient(90deg,#4CAF50,#2E7D32);padding:10px;border-radius:8px;color:#fff;font-weight:900">
              Ocorr√™ncia registrada com sucesso!
            </div>
          </div>
        </div>
      </div>

      <!-- HIST√ìRICO GEST√ÉO -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="subtitle">HIST√ìRICO DE OCORR√äNCIAS - GEST√ÉO</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-primary" onclick="carregarHistoricoGestao()">Atualizar</button>
          </div>
        </div>
        <div style="margin-top:12px" id="historyListGestao" class="historyList"></div>
      </div>
    </div> <!-- mainAppGestao -->

    <!-- MAIN APP - PROFESSOR -->
    <div id="mainAppProfessor" style="display:none;flex-direction:column;gap:14px">
      <div class="flex">
        <!-- PROFESSOR -->
        <div class="card col" style="flex:1">
          <div class="subtitle">REGISTRO ‚Äî PROFESSOR</div>
          <div class="col">
            <div class="form-row">
              <div class="form-group">
                <label>Professor</label>
                <select id="professor_select"></select>
              </div>
              <div class="form-group">
                <label>Turma</label>
                <select id="turma_select" onchange="onTurmaChange()"></select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group form-group-large">
                <label>Alunos (clique para selecionar)</label>
                <input id="alunos_selected_input" type="text" readonly placeholder="Clique para selecionar" onclick="openStudentsModal()">
                <div id="selectedPills" style="margin-top:8px"></div>
              </div>
              <div class="form-group form-group-small">
                <label>Data</label>
                <input id="data_prof" type="date">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Irregularidades</label>
                <div class="checkbox-group">
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Agress√£o"> Agress√£o
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Danos ao patrim√¥nio"> Danos ao patrim√¥nio
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Desacato"> Desacato
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Estava fora da sala"> Estava fora da sala
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Falta de material"> Falta de material
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Indisciplina"> Indisciplina
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="N√£o realiza as atividades"> N√£o realiza as atividades
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Saiu da sala sem autoriza√ß√£o"> Saiu da sala sem autoriza√ß√£o
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Uso de celular"> Uso de celular
                  </label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea id="descricao_prof" placeholder="Descreva a ocorr√™ncia..."></textarea>
              </div>
            </div>

            <div class="form-row">
              <button class="btn-primary" onclick="registrarOcorrenciaProfessor()">Registrar (Professor)</button>
              <button class="btn-danger" onclick="clearProfessorForm()">Limpar</button>
            </div>

            <div id="successProfessor" style="display:none;margin-top:10px;background:linear-gradient(90deg,#4CAF50,#2E7D32);padding:10px;border-radius:8px;color:#fff;font-weight:900">
              Ocorr√™ncia registrada com sucesso!
            </div>
          </div>
        </div>
      </div>

      <!-- HIST√ìRICO PROFESSOR -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="subtitle">HIST√ìRICO DE OCORR√äNCIAS - PROFESSOR</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-primary" onclick="carregarHistoricoProfessor()">Atualizar</button>
          </div>
        </div>
        <div style="margin-top:12px" id="historyListProfessor" class="historyList"></div>
      </div>
    </div> <!-- mainAppProfessor -->

    <!-- MODAL SELE√á√ÉO ALUNOS -->
    <div id="modalRoot" class="modal-root">
      <div class="modal">
        <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <strong>Selecionar alunos</strong>
          <button onclick="closeStudentsModal()" style="background:transparent;border:none;font-weight:900;cursor:pointer">‚úï</button>
        </header>

        <div>
          <input id="studentSearch" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px" oninput="filterStudentList()">
          <div id="studentList" class="studentList"></div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button class="btn-primary" onclick="confirmStudents()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModal()">Cancelar</button>
        </div>
      </div>
    </div>

  </div>

<script>
/*******************************
 * CONFIGURA√á√ïES
 *******************************/
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxg8AUMLs5trE5JzHdtiD88N-KN4r5aZ8HwL1j9NdPHQtB2l2TGaaMMRZbNlOGKJEWy/exec';
const SPREADSHEET_ID = '1u7qMsMHkZT47OZdar5qvshQDRA8XJrLgDjAZVOViAio';

// nomes de abas (front-end manda "sheet" para o Apps Script)
const SHEET_GERAL = 'BANCODEDADOSGERAL';
const SHEET_PROF = 'OCORRENCIASDOSPROFESSORES';
const SHEET_GESTAO = 'BANCODEALUNOS';

// estado
let allAlunos = [];
let alunosDaTurmaAtual = [];
let alunosSelecionados = [];
let professores = [];
let turmas = [];
let currentUserRole = null;
let alunosComRA = [];

/*******************************
 * INICIALIZA√á√ÉO
 *******************************/
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
  selectLoginOption('gestao'); // padr√£o
  carregarTurmasGestao();
});

/*******************************
 * LOGIN
 *******************************/
function selectLoginOption(role) {
  document.querySelectorAll('.login-option').forEach(opt => opt.classList.remove('active'));
  document.getElementById(`option${role.charAt(0).toUpperCase() + role.slice(1)}`).classList.add('active');
  document.querySelectorAll('.access-area').forEach(area => area.style.display = 'none');
  document.getElementById(`loginForm${role.charAt(0).toUpperCase() + role.slice(1)}`).style.display = 'block';
}

function login(role){
  let email, password;
  if (role === 'gestao') {
    email = document.getElementById('emailGestao').value.trim();
    password = document.getElementById('passwordGestao').value.trim();
  } else {
    email = document.getElementById('emailProfessor').value.trim();
    password = document.getElementById('passwordProfessor').value.trim();
  }
  if(role === 'gestao' && email === 'gestao@escola.com' && password === 'gestao123'){
    showAppAs(role, email);
  } else if(role === 'professor' && email === 'professor@escola.com' && password === 'prof123'){
    showAppAs(role, email);
  } else {
    alert('E-mail ou senha incorretos.');
  }
}

function fillDemo(role){ 
  if (role === 'gestao') {
    document.getElementById('emailGestao').value='gestao@escola.com'; 
    document.getElementById('passwordGestao').value='gestao123'; 
  } else {
    document.getElementById('emailProfessor').value='professor@escola.com'; 
    document.getElementById('passwordProfessor').value='prof123'; 
  }
}

function showAppAs(role, email){
  currentUserRole = role;
  document.getElementById('loginScreen').style.display = 'none';
  if (role === 'gestao') {
    document.getElementById('mainAppGestao').style.display = 'flex';
    document.getElementById('mainAppProfessor').style.display = 'none';
    carregarHistoricoGestao();
  } else {
    document.getElementById('mainAppGestao').style.display = 'none';
    document.getElementById('mainAppProfessor').style.display = 'flex';
    carregarProfessoresETurmas();
    carregarHistoricoProfessor();
  }
  document.getElementById('userDisplay').textContent = email + (role==='gestao'?' (Gest√£o)':' (Professor)');
  document.getElementById('btnLogout').style.display = 'inline-block';
  document.getElementById('btnDownloadPdf').style.display = 'inline-block';
}

function logout(){
  currentUserRole = null;
  document.getElementById('loginScreen').style.display = 'block';
  document.getElementById('mainAppGestao').style.display = 'none';
  document.getElementById('mainAppProfessor').style.display = 'none';
  document.getElementById('userDisplay').textContent = 'N√£o autenticado';
  document.getElementById('btnLogout').style.display = 'none';
  document.getElementById('btnDownloadPdf').style.display = 'none';
  alunosDaTurmaAtual = []; alunosSelecionados = []; document.getElementById('selectedPills').innerHTML='';
  document.getElementById('emailGestao').value = '';
  document.getElementById('passwordGestao').value = '';
  document.getElementById('emailProfessor').value = '';
  document.getElementById('passwordProfessor').value = '';
}

/*******************************
 * FUN√á√ïES GEST√ÉO
 *******************************/
async function carregarTurmasGestao() {
  try {
    const r = await fetch(`${SCRIPT_URL}?endpoint=classes&sheet=${encodeURIComponent(SHEET_GERAL)}`);
    const j = await r.json();
    turmas = (j && j.status==='success' && Array.isArray(j.classes)) ? j.classes : Object.keys(_getClassRanges());
    const turmaSelect = document.getElementById('serie_gestao');
    turmaSelect.innerHTML = '<option value="">-- Selecione a turma --</option>';
    turmas.forEach(t => { const opt=document.createElement('option'); opt.value=t; opt.textContent=t; turmaSelect.appendChild(opt); });
  } catch(err) { console.error('Erro turmas gest√£o:', err); }
}

async function carregarAlunosPorTurmaGestao(turma) {
  if (!turma) { document.getElementById('aluno_gestao').innerHTML = '<option value="">-- Selecione o aluno --</option>'; document.getElementById('ra_gestao').value=''; return; }
  try {
    const resp = await fetch(`${SCRIPT_URL}?endpoint=students&sheet=${encodeURIComponent(SHEET_GERAL)}&turma=${encodeURIComponent(turma)}`);
    const json = await resp.json();
    alunosComRA = json.studentsList || (json.students ? json.students.map(n=>({nome:n, ra:''})) : []);
    const alunoSelect = document.getElementById('aluno_gestao');
    alunoSelect.innerHTML = '<option value="">-- Selecione o aluno --</option>';
    alunosComRA.forEach(a => { const opt=document.createElement('option'); opt.value=a.nome; opt.textContent=a.nome; opt.setAttribute('data-ra', a.ra||''); alunoSelect.appendChild(opt); });
  } catch(err) { console.error('Erro alunos gest√£o:', err); }
}

function preencherRAGestao(){ const opt=document.getElementById('aluno_gestao').selectedOptions[0]; document.getElementById('ra_gestao').value= opt?opt.getAttribute('data-ra')||'':''; }

function toggleSuspension(area){ if(area==='gestao'){ const v=document.getElementById('classificacao_gestao').value; document.getElementById('suspensionRow_gestao').style.display=(v==='SUSPENS√ÉO')?'flex':'none'; } }

/*******************************
 * REGISTRAR OCORR√äNCIAS
 *******************************/
async function registrarOcorrenciaGestao(){
  const aluno=document.getElementById('aluno_gestao').value;
  const turma=document.getElementById('serie_gestao').value;
  const professor=document.getElementById('professor_gestao').value.trim();
  const disciplina=document.getElementById('disciplina_gestao').value.trim();
  const classificacao=document.getElementById('classificacao_gestao').value;
  const descricao=document.getElementById('descricao_gestao').value.trim();
  const dataRetorno=document.getElementById('dataRetorno_gestao').value||null;
  const ra=document.getElementById('ra_gestao').value;
  if(!aluno||!turma||!professor||!disciplina||!classificacao||!descricao){ return alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios.'); }
  if(classificacao==='SUSPENS√ÉO'&&!dataRetorno){ return alert('Informe data de retorno.'); }
  const payload={sheet:SHEET_GESTAO,startRow:2,date:new Date().toISOString().split('T')[0],professor,studentClass:turma,student:aluno,ra,disciplina,irregularities:classificacao+(dataRetorno?(' - retorno: '+dataRetorno):''),description:descricao};
  try {
    const r=await fetch(SCRIPT_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const j=await r.json();
    if(j.status==='success'){ alert("‚úÖ Ocorr√™ncia registrada com sucesso!"); document.getElementById('formGestao').reset(); document.getElementById('suspensionRow_gestao').style.display='none'; carregarHistoricoGestao(); }
    else alert("‚ùå Erro: "+(j.message||'falha ao registrar'));
  } catch(err){ console.error(err); alert("‚ùå Erro ao conectar com servidor."); }
}

async function registrarOcorrenciaProfessor(){
  const data=document.getElementById('data_prof').value;
  const professor=document.getElementById('professor_select').value;
  const turma=document.getElementById('turma_select').value;
  const descricao=document.getElementById('descricao_prof').value.trim();
  if(!data||!professor||!turma||alunosSelecionados.length===0||!descricao){ return alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios.'); }
  const irregs=Array.from(document.querySelectorAll('#formProfessor .irregularidades input:checked')).map(c=>c.value);
  const payload={sheet:SHEET_PROF,startRow:2,date:data,professor,studentClass:turma,student:alunosSelecionados.join(', '),irregularities:irregs.join(', '),description:descricao};
  try {
    const r=await fetch(SCRIPT_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const j=await r.json();
    if(j.status==='success'){ alert("‚úÖ Ocorr√™ncia registrada com sucesso!"); clearProfessorForm(); carregarHistoricoProfessor(); }
    else alert("‚ùå Erro: "+(j.message||'falha ao registrar'));
  } catch(err){ console.error(err); alert("‚ùå Erro ao conectar com servidor."); }
}

function clearProfessorForm(){ document.getElementById('formProfessor').reset(); alunosSelecionados=[]; document.getElementById('selectedPills').innerHTML=''; document.getElementById('data_prof').value=new Date().toISOString().split('T')[0]; }

/*******************************
 * HIST√ìRICO
 *******************************/
async function carregarHistoricoGestao(){ /* ... igual ao que voc√™ j√° tinha, apenas mantendo id, pdf e delete ... */ }
async function carregarHistoricoProfessor(){ /* ... igual ao que voc√™ j√° tinha ... */ }

/*******************************
 * DELETE & PDF
 *******************************/
async function deleteOccurrence(id){
  if(!id){return alert('ID inv√°lido');}
  if(!confirm('Excluir ocorr√™ncia ID '+id+'?'))return;
  try{
    const r=await fetch(`${SCRIPT_URL}?endpoint=delete-occurrence`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({occurrenceId:id,sheet:SHEET_PROF})});
    const j=await r.json();
    if(j.status==='success'){alert('üóëÔ∏è Ocorr√™ncia exclu√≠da.');carregarHistoricoGestao();}
    else alert('Erro ao excluir: '+(j.message||'desconhecido'));
  }catch(err){console.error(err);alert('Erro ao comunicar com servidor.');}
}

async function generatePdfFromBackend(id){
  if(!id){return alert('ID inv√°lido');}
  try{
    const r=await fetch(`${SCRIPT_URL}?endpoint=generate-pdf`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({occurrenceId:id,sheet:SHEET_PROF})});
    const j=await r.json();
    if(j.status==='success'&&j.pdfUrl){window.open(j.pdfUrl,'_blank');}
    else alert('Erro gerar PDF: '+JSON.stringify(j));
  }catch(err){console.error(err);alert('Erro PDF backend.');}
}

function generatePDFLocal(){ try{ const { jsPDF }=window.jspdf; const doc=new jsPDF(); doc.text('Registro de Ocorr√™ncia',14,20); doc.save(`ocorrencia_${Date.now()}.pdf`);}catch(err){alert('Erro PDF local');} }

 /*******************************
     * fallback: gerar PDF localmente (apenas conte√∫do simples)
     *******************************/
    function generatePDFLocal(){
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text('Registro de Ocorr√™ncia', 14, 20);
        const aluno = document.getElementById('aluno_gestao').value || '';
        const turma = document.getElementById('serie_gestao').value || '';
        const prof = document.getElementById('professor_gestao').value || '';
        const desc = document.getElementById('descricao_gestao').value || '';
        let y = 36;
        if(aluno){ doc.text(`Aluno: ${aluno}`, 14, y); y+=8; }
        if(turma){ doc.text(`Turma: ${turma}`, 14, y); y+=8; }
        if(prof){ doc.text(`Professor: ${prof}`, 14, y); y+=8; }
        doc.text('Descri√ß√£o:', 14, y); y+=8;
        const split = doc.splitTextToSize(desc || 'Sem descri√ß√£o', 180);
        doc.text(split, 14, y);
        doc.save(`ocorrencia_${Date.now()}.pdf`);
      } catch(err){ console.error('Erro gerar PDF local:', err); alert('Erro ao gerar PDF local (ver console).'); }
    }

    /*******************************
     * utilit√°rios / fallbacks
     *******************************/
    function _getClassRanges(){ return {
      "6¬∞ ANO A MANHA":"C3:C46","6¬∞ ANO B MANHA":"H3:H46","6¬∞ ANO C MANHA":"M3:M46","6¬∞ ANO D MANHA":"R3:R46",
      "6¬∞ ANO E TARDE":"W3:W46","6¬∞ ANO F TARDE":"AB3:AB46","7¬∞ ANO A TARDE":"AG3:AG46","7¬∞ ANO B TARDE":"AL3:AL46",
      "7¬∞ ANO C TARDE":"AQ3:AQ46","7¬∞ ANO D TARDE":"AV3:AV46","7¬∞ ANO E TARDE":"BA3:BA46","7¬∞ ANO F TARDE":"BF3:BF46",
      "8¬∞ ANO A TARDE":"BK3:BK46","8¬∞ ANO B TARDE":"BP3:BP46","8¬∞ ANO C TARDE":"BU3:BU46","8¬∞ ANO D TARDE":"BZ3:B46",
      "9¬∞ ANO A TARDE":"CE3:CE46","9¬∞ ANO B TARDE":"CJ3:CJ46","9¬∞ ANO C TARDE":"CO3:CO46","9¬∞ ANO D TARDE":"CT3:CT46",
      "1¬™ SERIE A MANHA":"CY3:CY46","1¬™ SERIE B MANHA":"DD3:DD46","1¬™ SERIE C MANHA":"DI3:DI46","1¬™ SERIE D MANHA":"DN3:DN46",
      "1¬™ SERIE E MANHA":"DS3:DS46","1¬™ SERIE F MANHA":"DX3:DX46","1¬™ SERIE G TARDE":"EC3:EC46","1¬™ SERIE H NOITE":"EH3:EH46",
      "1¬™ SERIE I NOITE":"EM3:EM46","2¬™ SERIE A MANHA":"ER3:ER46","2¬™ SERIE B MANHA":"EW3:EW46","2¬™ SERIE C MANHA":"FB3:FB46",
      "2¬™ SERIE D MANHA":"FG3:FG46","2¬™ SERIE E MANHA":"FL3:FL46","2¬™ SERIE F NOITE":"FQ3:FQ46","2¬™ SERIE G NOITE":"FV3:FV46",
      "2¬™ SERIE H NOITE":"GA3:GA46","3¬™ SERIE A MANHA":"GK3:GK46","3¬™ SERIE B MANHA":"GP3:GP46","3¬™ SERIE C MANHA":"GU3:GU46",
      "3¬™ SERIE D NOITE":"GZ3:GZ46","3¬™ SERIE E NOITE":"HE3:HE46","3¬™ SERIE F NOITE":"HJ3:HJ46"
    };}

    function getFallbackProfessores(){
      return [
        "ALEX LUTH PEREIRA MARANHAO","ALEXSANDRA PAULA VARELLA DE SOUZA","ALISON VASCONCELOS BESERRA","AMAURI TEODORO DE OLIVEIRA",
        "ANA PAULA DOS SANTOS","ANDREIA DOS SANTOS FREITAS","ANDREIA MADUREIRA REIS","ANTONIO CARLOS DE OLIVEIRA",
        "ANTONIO RAMOS DE ARAUJO","ANTONIO WILTON WANDERLEY CABRAL","AUGUSTO LINO PESSOA NETO","AUREA MARIA DE JESUS MARQUES",
        "CAROLINA PERNOMIAN PARUSSOLOLO","CASSIA OLIVEIRA ANTONIAZI","CLAUDINEIA DE AGUIAR LIMA","DANIEL DE FREITAS ALMEIDA",
        "DANIEL LOPES BARBOSA","DANIELA FERREIRA LIMA","DANIELLE LUCIA BATISTA DE ALMEIDA","EDIANE VIEIRA DA SILVA",
        "EDILEUSA NUNES PEREIRA","EDUARDO HENRIQUE DA FONSECA","ELIANE SANTOS SILVA","ELIAS MONTEIRO DA SILVERA",
        "ELISABETE APARECIDA PIRES","ELZA DE FARIA PEREIRA","EMERSON GABLER DE ALMEIDA","EUZELI ARAUJO DE OLIVEIRA",
        "FABIANO AUGUSTO PIEDADE","FABIO CAMILO","FERNANDO JOSE DA SILVA FILHO","FLAVIA CRISTINA APARECIDA BICHLER",
        "FLAVIO CARDOSO FLEURY","FRANCISCA EDIVANIA DE MORAIS COSTA","GABRIELA SERIGHELLI DE MELO","GELSON DE ALMEIDA BATISTA",
        "GENILTON DE OLIVEIRA SILVA","GIANI CRISTINA DO PRADO","INGRYD CAROLINA SUGUIMOTO VIEIRA","IVANILDES DOS SANTOS OSHIKAWA",
        "JANINA DOS PASSOS BRAGA DE ALMEIDA","JOSE APARECIDO DA SILVA","JUAREZ GOMES DE MAGALHAES FILHO","JUREMA SOLEDADE FURINI SANTOS",
        "KATIUSCIA ALVES BOMFIM","LUANA CAROLINE ALVES LIMA","LUANA DE FREITAS SILVA","LUCIANA NOVAIS CORREIA SANTOS",
        "LUCIANO MOREIRA DE AZEVEDO","MARCIEL DA SILVA","MARIA HELENA CUNHA MORO","MARIA QUIT√âRIA FERREIRA DOS SANTOS",
        "MARINA DA CONCEICAO FRANCISCO SILVA","MAURICIO DE BARROS SANTOS","MICHELE DE PINHO MORAES","MOISES ANTONIO DE BARROS",
        "PAULA ARMANI VILA","PAULO ROBERTO DA SILVA ITO","PEDRO ZANOTTI FILHO","RAUL PEREIRA VILERA JUNIOR",
        "REGIANE CURTI DE SOUZA OLIVEIRA","REGINA DA SILSA CASTRO","RICARDO AMERICO DA SILVA","ROBERTO SALGADO",
        "RODRIGO VIEIRA","ROSANGELA CAFASSO MOREIRA","ROSIMERY DE SOUZA PESSOA","ROSMARA DA SILSA CARDOSO",
        "SANDRA CRISTINA MACEDO MORAES","SELMA GOMES DA SILSA","SERGIO AGRIPINO VILLA NOVA","SOLANGE ALMEIDA DA SILSA",
        "SUZINEIDE SILSA DE FREITAS","THIAGO FABIANO BRITO","TITTO AUGUSTO NASCIMENTO SILSA","VANDERSON HYPPOLITO",
        "VANESSA IVETE GOMES DOS SANTOS","VANIA PENHA DE BARROS","VIVIANE LEAL CAMERA DE MORAES","WILSON RODRIGUES MOTA"
      ];
    }
</script>

